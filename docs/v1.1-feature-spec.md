# Win Pom Timer v1.1 追加機能仕様

## 1. スコープ

v1.1 では以下 2 機能を追加する。

1. 統計ダッシュボード強化
2. タスクカテゴリ管理（タグ）

除外事項:

- テンプレ機能は実装しない。
- ショートカットキー割り当て機能は実装しない。

## 2. メインUI変更

メイン画面の要素順を以下に固定する。

1. 時計
2. 操作ボタン
3. タグエリア
4. セッションメモ
5. 簡易統計（右端にグラフボタン）

変更点:

- 既存の `JSON/CSV/ICS` 出力ボタンはメイン画面から削除する。
- 簡易統計枠（`今日 / 今月 / 完了サイクル`）の右側に小さいグラフアイコンボタンを追加する。
- グラフアイコンボタン押下で「統計ウィンドウ」を開く。

## 3. 統計ダッシュボード強化

### 3.1 対象データ

- `Work` セッションのみを統計対象とする。
- `Short Break` / `Long Break` は統計時間に含めない。
- 集計元は `sessions.jsonl` とする。

### 3.2 統計ウィンドウUI

統計ウィンドウに以下を配置する。

1. グラフ種別プルダウン（`日 / 週 / 月 / 年`）
2. グラフ描画領域
3. エクスポートボタン（`JSON` `CSV` `ICS`）
4. カテゴリ別サマリー表示領域（時間・件数）

初期状態:

- グラフ種別プルダウンは未選択（空白）。
- グラフは描画しない。
- エクスポートボタンは使用可能。

### 3.3 グラフ仕様

- `日`: 当日 24 時間の時間帯別 Work 分数グラフ
- `週`: 週次（日別）Work 時間グラフ
  - 週の開始曜日は月曜固定
- `月`: 当月の日別 Work 時間グラフ
- `年`: 当年の月別 Work 時間グラフ
- グラフは積み上げ棒グラフとし、選択した集計軸カテゴリごとに色分け表示する。

### 3.4 タグ別統計

- 統計ウィンドウに集計軸切替を追加する。
  - 作業内容軸
  - クライアント軸
  - クライアント × 作業内容軸
- 複数選択タグは案分して集計する。
  - クライアント軸: セッション時間を選択クライアント数で等分
  - 作業内容軸: セッション時間を選択作業内容数で等分
  - クライアント × 作業内容軸: 組み合わせ数で等分
- 補完ルール:
  - クライアント軸未選択は `Self` として扱う
  - 作業内容軸未選択は `Uncategorized` として扱う
- 画面にはカテゴリごとの以下を表示する。
  - 合計時間
  - セッション件数
- タグ同時選択上限は無制限。

### 3.5 エクスポート仕様

- エクスポート機能は統計ウィンドウへ集約する。
- 出力形式は `JSON` `CSV` `ICS` を維持する。
- v1.1 ではエクスポート対象範囲は「全期間」とする（グラフ選択状態に依存しない）。

## 4. タスクカテゴリ管理（タグ）

### 4.1 タグデータモデル

タグは以下属性を持つ。

- `Id` (GUID)
- `Name` (1-24 文字、重複不可)
- `ColorHex` (`#RRGGBB`)
- `Axis` (`WorkType` / `Client` / `Other`)
- `IsArchived` (bool)

保存先:

- `settings.json` にタグ定義を保存する。

### 4.2 タグ管理UI

- 設定ウィンドウに「タグ管理」タブを追加する。
- タグの追加・編集・アーカイブを行える。
- 追加・編集時に軸（作業内容/クライアント/その他）を指定できる。
- アーカイブ済みタグは新規選択候補から除外する。

### 4.3 セッション中のタグ選択

- メイン画面のタグエリアでタグを複数選択できる。
- タグ選択は以下タイミングで編集可能とする。
  - Work 実行中
  - Work 終了後〜休憩開始前（メモ確定待ち）
- Work セッション確定時に、選択タグを該当 Work ログへ保存する。

### 4.4 ログ保存形式

`Work` ログに `Tags` フィールドを追加する。

- 型: `string[]`（タグ ID 配列）
- 既存ログとの互換性:
  - `Tags` 未存在は空配列扱い

## 5. 非機能要件

- 既存タイマー動作（開始/停止/再開/スキップ/リセット）を壊さない。
- 統計表示やタグ設定が失敗してもタイマー本体は継続動作する。
- 既存設定ファイルに新規項目がなくてもデフォルトで起動可能にする。

## 6. 受け入れ条件

1. メイン画面にエクスポートボタンがなく、統計アイコンから統計ウィンドウを開ける。
2. 統計ウィンドウ初期表示でグラフ未描画、かつ `JSON/CSV/ICS` エクスポートが実行できる。
3. プルダウン選択に応じて `日/週/月/年` の各グラフが描画される。
4. 週次集計が月曜始まりで計算される。
5. 年次表示で月別集計が表示される。
6. タグを無制限に選択でき、Work ログへ保存される。
7. Work 中および Work 終了後（休憩開始前）にタグとメモを編集できる。
8. タグに軸を設定でき、統計画面で軸ごとのカテゴリ集計に切り替えられる。
9. 複数選択時に案分ロジックで集計され、クライアント未選択は `Self`、作業内容未選択は `Uncategorized` で集計される。
